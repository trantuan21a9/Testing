coca_cola <- read.csv("C:/Users/ADMIN/Downloads/archive/Coca_Cola_historical_data.csv", header = TRUE, sep = ",")

child_coca_cola <- coca_cola[, c("Date", "Open", "High", "Low", "Close", "Volume")]

na_ratio <- colMeans(is.na(child_coca_cola))
print(na_ratio)

removing_outliers <- function(df, col) {
  x <- df[[col]]
  quartiles  <- quantile(x, probs = c(0.25, 0.75))  # Q1 và Q3
  iqr <- IQR(x)  # Khoảng tứ phân vị
  Lower <- quartiles[1]- 1.5*iqr
  Upper <- quartiles[2] + 1.5*iqr
  df[x >= Lower & x <= Upper, , drop = FALSE]  # Lọc dữ liệu trong khoảng cho phép
}

child_coca_cola <- removing_outliers(child_coca_cola, "Open")
child_coca_cola <- removing_outliers(child_coca_cola, "High")
child_coca_cola <- removing_outliers(child_coca_cola, "Low")
child_coca_cola <- removing_outliers(child_coca_cola, "Close")
child_coca_cola <- removing_outliers(child_coca_cola, "Volume")

child_coca_cola$Date <- as.Date(substr(child_coca_cola$Date, 1, 10))

write.csv(child_coca_cola, "preprocessed_coca_cola.csv", row.names = FALSE)
View(child_coca_cola)

get_mode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}

numeric_cols <- c("Open", "High", "Low", "Close", "Volume")

summary_stats <- data.frame(
  Variable = numeric_cols,
  Mean = sapply(child_coca_cola[numeric_cols], mean),
  Variance = sapply(child_coca_cola[numeric_cols], var),
  SD = sapply(child_coca_cola[numeric_cols], sd),
  Min = sapply(child_coca_cola[numeric_cols], min),
  Max = sapply(child_coca_cola[numeric_cols], max),
  Median = sapply(child_coca_cola[numeric_cols], median),
  Mode = sapply(child_coca_cola[numeric_cols], get_mode),
  Q1 = sapply(child_coca_cola[numeric_cols], function(x) quantile(x, 0.25)),
  Q2 = sapply(child_coca_cola[numeric_cols], function(x) quantile(x, 0.5)),
  Q3 = sapply(child_coca_cola[numeric_cols], function(x) quantile(x, 0.75))
)

print(summary_stats)

child_coca_cola$Volume_Category <- cut(child_coca_cola$Volume, breaks=3, labels=c("Thấp","Trung bình","Cao"))

freq_table <- table(child_coca_cola$Volume_Category)
print(freq_table)

barplot(freq_table, main="Biểu đồ cột Volume Category", col="skyblue",
        ylab="Số lượng", xlab="Nhóm Volume")

par(mfrow=c(2,3)) 
for(col in numeric_cols){
hist(child_coca_cola[[col]], main=paste("Histogram của", col), xlab=col, col="lightgreen", breaks=20)
  qqnorm(child_coca_cola[[col]], main=paste("Q-Q plot của", col))
  qqline(child_coca_cola[[col]], col="red")
}
par(mfrow=c(1,1))  

library(ggplot2)
library(reshape2)

eda_df <- child_coca_cola 

numeric_df <- eda_df[, sapply(eda_df, is.numeric)]

if (ncol(numeric_df) >= 4) {
  
  corr_matrix <- cor(numeric_df, use = "complete.obs")
  melted_corr_matrix <- melt(corr_matrix)
  
  plt <- ggplot(data = melted_corr_matrix, aes(x = Var1, y = Var2, fill = value)) +
    geom_tile() + 
    
    geom_text(aes(label = sprintf("%.2f", value)), color = "white", size = 4) +
    
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                         midpoint = 0, limit = c(-1, 1), name = "Độ tương quan") +
    
    theme_minimal() + 
    labs(title = "Ma trận tương quan (Heatmap)") +
    
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
  
  print(plt)
  
} else {
  print("Không đủ cột số để tạo heatmap tương quan có ý nghĩa.")
}
